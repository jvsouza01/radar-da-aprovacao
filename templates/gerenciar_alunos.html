<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Alunos - Mentoria Odisseia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .aluno-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #2a2a2a; padding: 10px 15px; margin-bottom: 8px; border-radius: 5px;
            border-left: 4px solid #555;
        }
        .aluno-item.alpha { border-left-color: #3b82f6; }
        .aluno-item.omega { border-left-color: #ef4444; }
        
        .actions { display: flex; gap: 10px; }
        .btn-edit { background: #f59e0b; color: #000; padding: 5px 10px; border: none; cursor: pointer; border-radius: 3px; font-weight: bold; }
        .btn-del { background: #ef4444; color: #fff; padding: 5px 10px; border: none; cursor: pointer; border-radius: 3px; font-weight: bold; }
        
        /* Form mode edit */
        .editing-mode input, .editing-mode select { border-color: #f59e0b; }
        .editing-mode button[type="submit"] { background-color: #f59e0b; color: black; }
    </style>
</head>
<body>
    <h1>Gerenciar Alunos</h1>
    
    <div class="container" style="flex-direction: column; align-items: center;">
        
        <div class="form-section" style="width: 100%; max-width: 600px;">
            <h2 id="form-title">Adicionar Novo Aluno</h2>
            <form id="form-aluno">
                <input type="hidden" id="aluno-id"> <label for="nome">Nome do Aluno:</label>
                <input type="text" id="nome" required placeholder="Ex: JoÃ£o Silva">
                
                <label for="time">Time:</label>
                <select id="time">
                    <option value="Sem Time">Sem Time</option>
                    <option value="Alpha">Alpha ðŸ”µ</option>
                    <option value="Omega">Omega ðŸ”´</option>
                </select>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="submit" id="btn-submit" style="flex: 2;">Adicionar Aluno</button>
                    <button type="button" id="btn-cancel" style="flex: 1; background: #555; display: none;">Cancelar</button>
                </div>
            </form>
        </div>

        <div class="info-column" style="width: 100%; max-width: 600px; margin-top: 20px;">
            <h3>Lista de Alunos Cadastrados</h3>
            <div id="lista-alunos">Carregando...</div>
        </div>
    </div>

    <a href="/" style="margin-top: 20px; font-weight: bold;">Voltar para o Menu</a>

    <script>
        const form = document.getElementById('form-aluno');
        const listaDiv = document.getElementById('lista-alunos');
        const formTitle = document.getElementById('form-title');
        const btnSubmit = document.getElementById('btn-submit');
        const btnCancel = document.getElementById('btn-cancel');
        const inputId = document.getElementById('aluno-id');
        const inputNome = document.getElementById('nome');
        const inputTime = document.getElementById('time');

        // 1. Carregar Alunos
        async function carregarAlunos() {
            const res = await fetch('/api/alunos-com-time');
            const alunos = await res.json();
            
            listaDiv.innerHTML = '';
            alunos.forEach(aluno => {
                const div = document.createElement('div');
                div.className = `aluno-item ${aluno.time ? aluno.time.toLowerCase() : ''}`;
                div.innerHTML = `
                    <div>
                        <strong>${aluno.nome}</strong>
                        <span style="font-size:0.8em; opacity:0.7; margin-left:10px;">(${aluno.time || 'Sem Time'})</span>
                    </div>
                    <div class="actions">
                        <button class="btn-edit" onclick="prepararEdicao(${aluno.id}, '${aluno.nome}', '${aluno.time}')">Editar</button>
                        <button class="btn-del" onclick="deletar(${aluno.id}, '${aluno.nome}')">X</button>
                    </div>
                `;
                listaDiv.appendChild(div);
            });
        }

        // 2. Salvar (Criar ou Editar)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = inputId.value;
            const dados = { nome: inputNome.value, time: inputTime.value };
            
            let url = '/api/alunos';
            let method = 'POST';

            if (id) { // Modo EdiÃ§Ã£o
                url = `/api/alunos/${id}`;
                method = 'PUT';
            }

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dados)
                });
                
                if (res.ok) {
                    alert(id ? 'Aluno atualizado!' : 'Aluno criado!');
                    resetarForm();
                    carregarAlunos();
                } else {
                    const erro = await res.json();
                    alert('Erro: ' + erro.erro);
                }
            } catch (err) { console.error(err); }
        });

        // 3. Preparar EdiÃ§Ã£o
        window.prepararEdicao = (id, nome, time) => {
            inputId.value = id;
            inputNome.value = nome;
            inputTime.value = time || 'Sem Time';
            
            // Muda visual do form
            formTitle.innerText = `Editando: ${nome}`;
            btnSubmit.innerText = "Salvar AlteraÃ§Ãµes";
            btnCancel.style.display = "block";
            form.parentElement.classList.add('editing-mode');
            
            // Rola para cima
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // 4. Cancelar EdiÃ§Ã£o
        btnCancel.addEventListener('click', resetarForm);

        function resetarForm() {
            inputId.value = '';
            inputNome.value = '';
            inputTime.value = 'Sem Time';
            formTitle.innerText = "Adicionar Novo Aluno";
            btnSubmit.innerText = "Adicionar Aluno";
            btnCancel.style.display = "none";
            form.parentElement.classList.remove('editing-mode');
        }

        // 5. Deletar
        window.deletar = async (id, nome) => {
            if(!confirm(`ATENÃ‡ÃƒO: Deletar o aluno "${nome}" apagarÃ¡ todo o histÃ³rico de questÃµes e simulados dele.\n\nTem certeza?`)) return;
            
            await fetch(`/api/alunos/${id}`, { method: 'DELETE' });
            carregarAlunos();
        }

        carregarAlunos();
    </script>
</body>
</html>